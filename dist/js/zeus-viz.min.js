/*! Copyright (C) 2015. ZeusJS 
zeus-viz - v0.0.1. */
"use strict";angular.module("zeus.viz",[]),angular.module("zeus.viz").directive("zsDonut",["$timeout",function(a){var b,c;return c=function(a,b,c,d){if(a.values&&a.values.length){c.attr("width",0).attr("height",0);var e,f,g,h,i,j,k,l,m,n,o,p=b[0].parentElement,q=p.clientWidth-20,r=p.clientHeight-20,s=a.showLegend?20:0,t=a.showLegend?10:0,u=[],v=0;.5*q>r&&(r=.5*q+s+t),c.attr("width",q).attr("height",r),e=Math.min(q,r-s-t)/2,i=Math.max(q,2*e)/2,j=Math.max(r-s-t,2*e)/2,m=c.select("g.donut-fragment").attr("transform","translate("+i+","+j+")"),o=a.title,m.select("text.donut-title").attr("x",0).attr("y",0).style("font-size",e/2+"px").text(o),m.select("text.donut-subtitle").attr("x",0).attr("y",e/4).style("font-size",e/6+"px").text(a.subtitle),n=c.select("g g.legend-fragment"),f=d3.svg.arc().outerRadius(.95*e).innerRadius(.75*e),h=function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return f(b(a))}},g=d3.layout.pie().sort(null).value(function(a){return a.value}),k=m.selectAll("path").data(g(a.values)),k.attr("fill",function(b,c){return a.segmentColor({$val:b.data,$index:c})}).each(function(a){this._current={startAngle:a.startAngle,endAngle:a.startAngle,value:0}}).transition().duration(800).attrTween("d",h),k.enter().append("path").attr("fill",function(b,c){return a.segmentColor({$val:b.data,$index:c})}).each(function(a){this._current={startAngle:a.startAngle,endAngle:a.startAngle,value:0}}).transition().duration(800).attrTween("d",h),k.exit().each(function(a){a.startAngle=2*Math.PI-.001,a.endAngle=2*Math.PI}).transition().duration(800).attrTween("d",h).remove(),k.on("mouseover",d.show).on("mouseout",d.hide),a.showLegend?(n.selectAll("g.legend-label text").remove(),n.selectAll("g.legend-label circle").remove(),l=n.selectAll("g.legend-label").data(a.values),l.enter().append("g").attr("class","legend-label").attr("transform",function(b,c){return"translate("+q/a.values.length*c+", 0)"}),l.attr("transform",function(b,c){return"translate("+q/a.values.length*c+", 0)"}),l.exit().remove(),l=n.selectAll("g.legend-label"),window.legendLabels=l,l.append("circle").attr("cx","8").attr("cy","8").attr("r","5").attr("fill",function(b,c){return a.segmentColor({$val:b,$index:c})}),l.append("text").attr("x","17").text(function(a){return a.label}).attr("y",function(a,b){var c=this.getComputedTextLength(),d=30+c;return u.push(0===b?d:u[b-1]+d),8}).attr("dy",5).attr("text-anchor","start"),l.attr("transform",function(a,b){return 0===b?"translate(0, 0)":"translate("+u[b-1]+", 0)"}),v=u[u.length-1],n.attr("transform","translate("+(q-v)/2+","+(r-s)+")")):l=n.selectAll("g.legend-label").remove()}},b=function(b,d,e){var f,g,h,i,j,k=$(d).parent(),l=$(window);b.showLegend=!!e.showLegend,f=d3.select(d[0]).attr("class","zs-donut"),j=d3.tip().attr("class","d3-tip").html(function(a){return a.data.label+": "+a.data.value}),f.call(j),g=f.append("g"),h=g.append("g").attr("class","donut-fragment"),h.append("text").attr("class","donut-title").attr("text-anchor","middle"),h.append("text").attr("class","donut-subtitle").attr("text-anchor","middle"),g.append("g").attr("class","legend-fragment"),k.is(":visible")&&c(b,d,f,j),b.$watch(function(){var a=k.is(":visible");return a},function(){k.is(":visible")&&c(b,d,f,j)}),l.on("resize.donut_"+b.$id,function(){var e=k.is(":visible");i&&a.cancel(i),e&&(i=a(function(){c(b,d,f,j)},500))}),b.$on("$destroy",function(){l.off("resize.donut_"+b.$id)}),b.$watch("lastUpdate",function(){k.is(":visible")&&c(b,d,f,j)})},{templateNamespace:"svg",template:"<svg></svg>",replace:!0,restrict:"E",scope:{percentage:"=?",segmentColor:"&",values:"=?",total:"=?",title:"@text",subtitle:"@",lastUpdate:"=?"},link:b}}]);